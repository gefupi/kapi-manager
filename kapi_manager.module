<?php
/*
 * This function implements hook_block_info()
 */
function kapi_manager_block_info() {
  $blocks['kapi_manager'] = array(
    'info'  => t('Kapi-Manager Menu'),
    'cache' => DRUPAL_CACHE_PER_ROLE,
  );
  return $blocks;
}


/*
 * This function implements hook_block_view()
 */
function kapi_manager_block_view($delta='') {
  switch ($delta) {
    case 'kapi_manager':
      $block['subject'] = t('Managing');
      $items = array();
      $items[] = array(
        'data' => l('product overview', 'kapi_manager/product_overview'),
      );
      $block['content']['posts'] = array(
        '#items' => $items,
        '#theme' => 'item_list__kapi_manager__block',
      );
/*
      $block['content']['products'] = array(
        '#title' => t('See full list of products'),
        '#url' => 'kapi_manager',
        '#theme' => 'more_link__kapi_manager',
      );
*/
      return $block;
      break;
  }
}



/*
 * This function generates a product overview page.
 */
function _kapi_manager_product_overview_page() {
  drupal_set_title('Product overview');
  $result = _kapi_manager_products();
  $items = array();
  foreach ($result as $product) {
    $items[] = array(
      'data' => $product->id . "\t" . $product->name,
    );
  }
  $page_array['kapi_manager_arguments'] = array(
    '#title' => t('List of known products:'),
    '#items' => $items,
    '#theme' => 'item_list__kapi_manager',
  );
  return $page_array;
}


/*
 * This function is returns a ResultSet containing all products from db.
 */
function _kapi_manager_products() {
  $query = db_select('kapi_manager_products', 'p')
    ->fields('p', array('id', 'name'));
  return $query->execute();
}


/*
 * This function implements hook_permission()
 */
function kapi_manager_permission() {
  return array(
    'access kapi_manager content' => array(
      'title' => t('Access content for the Kapi-Manager module.'),
    ),
    'administrate kapi_manager content' => array(
      'title' => t('Administrate content for the Kapi-Manager module.'),
      'restrict access' => TRUE,
    ),
  );
}


/*
 * This function implements hook_menu()
 */
function kapi_manager_menu() {
  $items = array();

  $items['kapi_manager/product_overview'] = array(
    'title' => 'Kapi-Manager',
    'page callback' => '_kapi_manager_product_overview_page',
    'access arguments' => array('access kapi_manager content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}
