<?php
/*
 * This function generates a page containing the product list.
 */
function kapi_manager_list_products_page() {
  drupal_set_title('Product');
  module_load_include('php', 'kapi_manager', 'database/product_handler');
  $result = _kapi_manager_get_products();
  $rows = array();
  foreach ($result as $product) {
    $rows[] = array(
      array('data' => $product->id,),
      array('data' => $product->name,),
    );
  }
  $header = array(
    array('data' => 'id', 'align' => 'center'),
    array('data' => 'name', 'align' => 'center'),
  );
  return theme('table', array('header' => $header, 'rows' => $rows));
}


/**
 * This function implements hook_permission()
 */
function kapi_manager_permission() {
  return array(
    'access kapi_manager content' => array(
      'title' => t('Access content for the Kapi-Manager module.'),
    ),
    'administrate kapi_manager content' => array(
      'title' => t('Administrate content for the Kapi-Manager module.'),
      'restrict access' => TRUE,
    ),
  );
}


/*
 * This function implements hook_menu()
 */
function kapi_manager_menu() {
  $items = array();
  // TODO: switch admin permission after development/testing
//  $admin_access = array('access kapi_manager administrate');
  $admin_access = array('access kapi_manager content');
  $user_access = array('access kapi_manager content');

  $items['kapi_manager/admin'] = array(
    'title' => 'Administration',
    'page callback' => 'kapi_manager_test_page',
    'access arguments' => $admin_access,
    'type' => MENU_NORMAL_ITEM,
    'menu_name' => 'kapi_manager',
  );

  $items['kapi_manager/admin/products'] = array(
    'title' => 'Products',
    'page callback' => 'kapi_manager_list_products_page',
    'access arguments' => $admin_access,
    'type' => MENU_NORMAL_ITEM,
    'menu_name' => 'kapi_manager',
  );

  $items['kapi_manager/admin/products/list'] = array(
    'title' => 'list',
    'access arguments' => $admin_access,
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'menu_name' => 'kapi_manager',
    'wight' => 0,
  );

  $items['kapi_manager/admin/products/edit'] = array(
    'title' => 'edit',
    'page callback' => 'kapi_manager_edit_products_page',
    'access arguments' => $admin_access,
    'type' => MENU_LOCAL_TASK,
    'menu_name' => 'kapi_manager',
    'weight' => 1,
  );

  $items['kapi_manager/admin/products/add'] = array(
    'title' => 'add a product',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('kapi_manager_add_product_form'),
    'access arguments' => $admin_access,
    'type' => MENU_LOCAL_ACTION,
    'menu_name' => 'kapi_manager',
  );

  return $items;
}


function kapi_manager_test_page() {
  return t('Hello! This is a test page.');
}

function kapi_manager_edit_products_page() {
  return t('TODO: implement edit product page');
}






/**
 * wrapper to call private form function in forms/admin_products.php
 */
function kapi_manager_add_product_form($node, &$form_state) {
  module_load_include('php', 'kapi_manager', 'forms/admin_products');
  return _kapi_manager_add_product_form($node, $form_state);
}

/**
 * wrapper to call private form validate function in forms/admin_products.php
 */
function kapi_manager_add_product_form_validate($form, &$form_state) {
  module_load_include('php', 'kapi_manager', 'forms/admin_products');
  return _kapi_manager_add_product_form_validate($form, $form_state);
}

/**
 * wrapper to call private form submit function in forms/admin_products.php
 */
function kapi_manager_add_product_form_submit($form, &$form_state) {
  module_load_include('php', 'kapi_manager', 'forms/admin_products');
  return _kapi_manager_add_product_form_submit($form, $form_state);
}

